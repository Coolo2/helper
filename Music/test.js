const discord=require("discord.js-light"),youtube=require("youtube-sr").default,functions=require("./functions.js"),classes=require("./classes"),ytdl=require("discord-ytdl-core"),genius=require("genius-lyrics"),dotenv=require("dotenv");dotenv.config();const axios=require("axios").default,voice=require("@discordjs/voice"),lyricsClient=new genius.Client;process.env.UV_THREADPOOL_SIZE=128,process.on("uncaughtException",function(e){console.log("Caught exception: ",e.lineNumber)});const bot=new discord.Client({makeCache:discord.Options.cacheWithLimits({ApplicationCommandManager:1/0,BaseGuildEmojiManager:1/0,ChannelManager:1/0,GuildChannelManager:1/0,GuildBanManager:1/0,GuildInviteManager:1/0,GuildManager:1/0,GuildMemberManager:1/0,GuildStickerManager:1/0,MessageManager:1/0,PermissionOverwriteManager:1/0,PresenceManager:0,ReactionManager:1/0,ReactionUserManager:1/0,RoleManager:1/0,StageInstanceManager:1/0,ThreadManager:1/0,ThreadMemberManager:1/0,UserManager:1/0,VoiceStateManager:1/0}),intents:[discord.Intents.FLAGS.GUILD_MEMBERS,discord.Intents.FLAGS.GUILD_VOICE_STATES]});async function getMusicPermissions(e){return url=`https://helperdata.glitch.me/view${process.env.databaseToken}/databases/music.json`,data=(await axios.get(url)).data,guildData=data[e],guildData||(guildData={}),guildData.permissions||(guildData.permissions=permissionsAll),guildData}async function doVotes(e,i,s,o,r){for(memberM of(guilds[r].votes[e]||(guilds[r].votes[e]={}),mGuild=guilds[r],voted=!1,vcMembers=0,i.voice.channel.members))memberM[1].user.bot||memberM[1].voice.deaf||(vcMembers+=1);if(required=Math.ceil(vcMembers/2),length=Object.keys(guilds[r].votes[e]).length+1,mGuild.queue[0].requestor.id==i.id);else if(o.has(s.permissions));else if(vcMembers<3);else{if(voted=!0,inFile=!1,mGuild.votes[e]||(guilds[r].votes[e]={}),guilds[r].votes[e][i.user.id]&&(inFile=!0),guilds[r].votes[e][i.user.id]=!0,inFile)return length-=1,{do:!1,voted:!1,votes:length,required:required};if(!(length>=required))return{do:!1,voted:!0,votes:length,required:required};guilds[r].votes[e]={}}return{do:!0,voted:voted,votes:length,required:required}}function calculateFilters(e){return filtersArr=["-af"],e.pitch?e.speed?filtersArr.push(`asetrate=48000*2^(${e.pitch}/12),atempo=${e.speed/100}`):filtersArr.push(`asetrate=48000*2^(${e.pitch}/12),atempo=1/2^(${e.pitch}/12)`):e.bass&&filtersArr.push(`bass=g=${e.bass/100}`),e.speed&&!e.pitch&&filtersArr.push(`atempo=${e.speed/100}`),1==filtersArr.length&&(filtersArr=[]),filtersArr}async function playLoop(e){mGuild=guilds[e.id],mGuild.stream=ytdl(mGuild.queue[mGuild.index].video.id,{seek:mGuild.queue[mGuild.index].seek,filter:"audioonly",highWaterMark:1<<25,opusEncoded:!0,encoderArgs:calculateFilters(mGuild.filters)}),mGuild.player=voice.createAudioPlayer(),mGuild.resource=voice.createAudioResource(mGuild.stream,{inlineVolume:!0});try{mGuild.connection=await voice.joinVoiceChannel({channelId:mGuild.voiceChannel.id,guildId:mGuild.guild.id,adapterCreator:mGuild.guild.voiceAdapterCreator})}catch{return await mGuild.playInteraction.reply({embeds:[functions.getEmbed(errors.VoicePermissions)]}),void await guilds[e.id].stop()}await mGuild.player.play(mGuild.resource),mGuild.connection.subscribe(mGuild.player),mGuild.startedAt=new Date,mGuild.startedTime=mGuild.queue[mGuild.index].seek,mGuild.player.addListener("stateChange",async function(i,s){if("idle"==s.status)if(await mGuild.skip(),guilds[e.id])embed=await getNowPlaying(e.id),message=await guilds[e.id].textChannel.send({embeds:[embed]}),guilds[e.id].nowPlayingMessage&&await guilds[e.id].nowPlayingMessage.delete(),guilds[e.id].nowPlayingMessage=message;else try{await mGuild.textChannel.send({embeds:[functions.getEmbed("Queue ended","The queue for this server ended. Left the voice channel.")]})}catch{}})}async function autocomplete_play(e){if(!e.member.voice.channelId)return e.respond([{name:"Please join a voice channel in this server. If you are in one, leave and rejoin.",value:""}]);if(!e.options.getString("song"))return e.respond([{name:"Please type at least 3 characters to show results. Otherwise send without clicking a result",value:""}]);if(!(e.options.getString("song").length>2))return e.respond([{name:"Please type at least 3 characters to show results. Otherwise send without clicking a result",value:""}]);if(songCache[e.options.getString("song")])return e.respond(songCache[e.options.getString("song")]);try{for(video of(search=await youtube.search(e.options.getString("song"),{limit:5}),response=[],search))response.push({name:video.title,value:`https://youtube.com/watch?v=${video.id}`});return songCache[e.options.getString("song")]=response,e.respond(response)}catch{console.log("ERR ON SEARCH")}}async function autocomplete_queueItem(e,i,s=!1){if(mGuild=guilds[e.guild.id],!mGuild)return e.respond([{name:"Nothing is playing in this server!",value:""}]);for(video of(options=[],counter=0,mGuild.queue))counter+=1,s&&counter<2||e.options.getString(i)&&!`${counter}. ${video.video.title}`.toLowerCase().includes(e.options.getString(i).toLowerCase())||options.push({name:`${counter}. ${video.video.title}`,value:counter.toString()});return e.respond(options)}async function command_skipto(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(musicPermissions=await getMusicPermissions(e.guild.id),!(musicPermissions.commands&&musicPermissions.commands.skipto||e.memberPermissions.has(musicPermissions.permissions)))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]});if(track=e.options.getString("track"),isNaN(track))return e.reply({embeds:[functions.getErrorEmbed(`Could not find valid track/index from \`${track}\`... Maybe try use the options provided?`)]});if(track=parseInt(track),index=track-1,index>guilds[e.guild.id].queue.length)return e.reply({embeds:[functions.getErrorEmbed(`Could not find valid track/index from \`${track}\`... Maybe try use the options provided?`)]});for(removed of(await e.deferReply(),removed=guilds[e.guild.id].queue.splice(0,index),removed))guilds[e.guild.id].history.push(removed);return await guilds[e.guild.id].playLoop(),nowPlaying=await getNowPlaying(e.guild.id),await e.followUp({embeds:[nowPlaying.setColor("#00FF00")]})}async function command_restart(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(musicPermissions=await getMusicPermissions(e.guild.id),musicPermissions.commands&&musicPermissions.commands.restart&&"permissions"!=musicPermissions.commands.restart){if("voting"==musicPermissions.commands.restart&&(vote=await doVotes("restart",e.member,musicPermissions,e.memberPermissions,e.guild.id),!vote.do))return vote.voted?await e.reply({embeds:[functions.getEmbed(`Voted to restart song (${vote.votes}/${vote.required})`,"Get more votes and the song will be restarted (others have to do `/restart`)")]}):await e.reply({embeds:[functions.getErrorEmbed(`You have already voted to restart! (${vote.votes}/${vote.required})`)]})}else if(!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]});return await e.deferReply(),guilds[e.guild.id].queue[0].seek=0,await guilds[e.guild.id].playLoop(),nowPlaying=await getNowPlaying(e.guild.id),await e.followUp({embeds:[nowPlaying.setColor("#00FF00")]})}async function command_remove(e){return e.member.voice.channelId?guilds[e.guild.id]&&guilds[e.guild.id].queue?(musicPermissions=await getMusicPermissions(e.guild.id),musicPermissions.commands&&musicPermissions.commands.remove||e.memberPermissions.has(musicPermissions.permissions)?(track=e.options.getString("track"),isNaN(track)?e.reply({embeds:[functions.getErrorEmbed(`Could not find valid track/index from \`${track}\`... Maybe try use the options provided?`)]}):(track=parseInt(track),index=track-1,index>guilds[e.guild.id].queue.length?e.reply({embeds:[functions.getErrorEmbed(`Could not find valid track/index from \`${track}\`... Maybe try use the options provided?`)]}):(removed=guilds[e.guild.id].queue.splice(index,1),await e.reply({embeds:[functions.getSuccessEmbed("Successfully removed track from queue",`Removed [${removed[0].video.title}](https://youtube.com/watch?v=${removed[0].video.id}) from queue`)]})))):e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})):e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]}):e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]})}function addGuildFunctions(e){guilds[e].stop=async function(){guilds[e].connection.destroy(),delete guilds[e]},guilds[e].skip=async function(){guilds[e].queue.length>1?("queue"==guilds[e].loop?(guilds[e].index+=1,guilds[e].index>guilds[e].queue.length-1&&(guilds[e].index=0)):"track"!=guilds[e].loop&&(guilds[e].history.push(guilds[e].queue[0]),guilds[e].queue.shift()),await guilds[e].playLoop()):"track"!=guilds[e].loop&&"queue"!=guilds[e].loop?await guilds[e].stop():await guilds[e].playLoop()}}async function command_skip(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(musicPermissions.commands&&"permissions"==musicPermissions.commands.skip){if(!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})}else if(!(musicPermissions.commands&&musicPermissions.commands.skip&&"voting"!=musicPermissions.commands.skip||(vote=await doVotes("skip",e.member,musicPermissions,e.memberPermissions,e.guild.id),vote.do)))return vote.voted?await e.reply({embeds:[functions.getEmbed(`Voted to skip song (${vote.votes}/${vote.required})`,"Get more votes and the song will be skipped (others have to do `/skip`)")]}):await e.reply({embeds:[functions.getErrorEmbed(`You have already voted to skip! (${vote.votes}/${vote.required})`)]});if(skipped="","track"==guilds[e.guild.id].loop&&(guilds[e.guild.id].loop=null,skipped=", disabled loop,"),"queue"==guilds[e.guild.id].loop){if(guilds[e.guild.id].index>0)for(var i=0;i<guilds[e.guild.id].index;i++)guilds[e.guild.id].history.push(guilds[e.guild.id].queue[0]),guilds[e.guild.id].queue.shift();guilds[e.guild.id].index=0,guilds[e.guild.id].loop=null,skipped=", disabled loop,"}return await mGuild.skip(),guilds[e.guild.id]?(nowPlaying=await getNowPlaying(e.guild.id),""!=skipped&&nowPlaying.setTitle("[Disabled Loop] Now Playing:"),await e.reply({embeds:[nowPlaying.setColor("#00FF00")]})):await e.reply({embeds:[functions.getSuccessEmbed("Successfully skipped song",`**Queue ended.** Skipped the song${skipped} and left the voice channel`)]})}async function command_loop(e){return e.member.voice.channelId?guilds[e.guild.id]&&guilds[e.guild.id].queue?(musicPermissions=await getMusicPermissions(e.guild.id),musicPermissions.commands&&musicPermissions.commands.loop||e.memberPermissions.has(musicPermissions.permissions)?("off"==e.options.getString("type")?guilds[e.guild.id].loop=null:guilds[e.guild.id].loop=e.options.getString("type"),void await e.reply({embeds:[functions.getSuccessEmbed("Successfully set loop",`Successfully set loop to **${e.options.getString("type")}**`)]})):e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})):e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]}):e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]})}async function command_stop(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(musicPermissions.commands&&"permissions"==musicPermissions.commands.stop){if(!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})}else if(!(musicPermissions.commands&&musicPermissions.commands.stop&&"voting"!=musicPermissions.commands.stop||(vote=await doVotes("stop",e.member,musicPermissions,e.memberPermissions,e.guild.id),vote.do)))return vote.voted?await e.reply({embeds:[functions.getEmbed(`Voted to stop song (${vote.votes}/${vote.required})`,"Get more votes and the song will be stopped (others have to do `/stop`)")]}):await e.reply({embeds:[functions.getErrorEmbed(`You have already voted to stop! (${vote.votes}/${vote.required})`)]});return mGuild=guilds[e.guild.id],await guilds[e.guild.id].stop(),await e.reply({embeds:[functions.getSuccessEmbed("Successfully stopped player",`Stopped playing **[${mGuild.queue[0].video.title}](https://youtube.com/watch?v=${mGuild.queue[0].video.id})** in **<#${mGuild.voiceChannel.id}>**`)]})}async function command_play(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(musicPermissions=await getMusicPermissions(e.guild.id),musicPermissions.commands&&musicPermissions.commands.play&&!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]});try{voiceChannel=await bot.channels.fetch(e.member.voice.channelId)}catch{return await e.reply({embeds:[functions.getErrorEmbed(errors.VoicePermissions)]})}if(await e.deferReply(),search=[],e.options.getString("song").includes("youtu"))try{info=await ytdl.getInfo(e.options.getString("song"));var i=Math.floor(info.videoDetails.lengthSeconds/60),s=info.videoDetails.lengthSeconds-60*i;search=[{title:info.videoDetails.title,id:info.videoDetails.videoId,thumbnail:{url:`https://img.youtube.com/vi/${info.videoDetails.videoId}/0.jpg`},duration:1e3*info.videoDetails.lengthSeconds,durationFormatted:`${i}:${s.toString().padStart(2,"0")}`}]}catch{search=await youtube.search(e.options.getString("song"),{limit:1})}else search=await youtube.search(e.options.getString("song"),{limit:1});return 0==search.length?await e.followUp({embeds:[functions.getErrorEmbed(errors.NoSongFound)]}):(e.options.getInteger("seek")?seek=e.options.getInteger("seek"):seek=0,queueData={video:search[0],search:e.options.getString("song"),requestor:e.member,seek:seek},guilds[e.guild.id]?(guild=guilds[e.guild.id],guild.queue.push(queueData)):(guilds[e.guild.id]=new classes.musicGuild(bot,e.guild),guild=guilds[e.guild.id],guild.queue=[],guild.voiceChannel=voiceChannel,guild.textChannel=e.channel,guild.index=0,guild.history=[],guild.votes={},guild.nowPlayingMessage=void 0,guild.loop=null,guild.playInteraction=e,guild.filters={},addGuildFunctions(e.guild.id),guild.queue.push(queueData),guild.playLoop=async function(){await playLoop(e.guild)},await guild.playLoop()),nowPlaying=await getNowPlaying(e.guild.id,index=guild.queue.length-1),await e.followUp({embeds:[nowPlaying.setColor("#00FF00")]}))}async function command_back(e){if(mGuild=guilds[e.guild.id],!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(!mGuild.history||0==mGuild.history.length)return e.reply({embeds:[functions.getErrorEmbed(errors.NoBack)]});if(musicPermissions.commands&&"permissions"==musicPermissions.commands.back){if(!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})}else if(!(musicPermissions.commands&&musicPermissions.commands.back&&"voting"!=musicPermissions.commands.back||(vote=await doVotes("back",e.member,musicPermissions,e.memberPermissions,e.guild.id),vote.do)))return vote.voted?await e.reply({embeds:[functions.getEmbed(`Voted to go back (${vote.votes}/${vote.required})`,"Get more votes and the player will go back (others have to do `/back`)")]}):await e.reply({embeds:[functions.getErrorEmbed(`You have already voted to go back! (${vote.votes}/${vote.required})`)]});return await e.deferReply(),popped=guilds[e.guild.id].history.pop(),item=guilds[e.guild.id].queue[0],guilds[e.guild.id].queue.splice(0,1),guilds[e.guild.id].queue.unshift(popped,item),await guilds[e.guild.id].playLoop(),nowPlaying=await getNowPlaying(e.guild.id),await e.followUp({embeds:[nowPlaying.setColor("#00FF00")]})}async function command_nowplaying(e){return e.member.voice.channelId?guilds[e.guild.id]&&guilds[e.guild.id].queue?(nowPlaying=await getNowPlaying(e.guild.id),await e.reply({embeds:[nowPlaying.setColor("#00FF00")]})):e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]}):e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]})}async function command_lyrics(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});mGuild=guilds[e.guild.id],await e.deferReply();try{searches=await lyricsClient.songs.search(mGuild.queue[0].video.title)}catch{return e.followUp({embeds:[functions.getErrorEmbed(`Could not find lyrics for ${mGuild.queue[0].video.title}`)]})}return lyrics=await searches[0].lyrics(),lyrics.length>2047&&(lyrics=lyrics.substring(0,2047)),embed=functions.getSuccessEmbed(`Lyrics for ${mGuild.queue[0].video.title}`,lyrics),await e.followUp({embeds:[embed]})}async function command_queue(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});for(video of(mGuild=guilds[e.guild.id],queue="_ _ ",history="_ _ ",counter=0,mGuild.queue))counter+=1,counter==mGuild.index+1&&(queue+="**"),video.video.title?queue+=`${counter}. [${video.video.title}](https://youtube.com/watch?v=${video.video.id}) - Requested by: ${video.requestor.user.username}#${video.requestor.user.discriminator} - ${video.video.durationFormatted}\n`:queue+=`${counter}. https://youtube.com/watch?v=${video.video.id} - Requested by: ${video.requestor.user.username}#${video.requestor.user.discriminator}\n`,counter==mGuild.index+1&&(queue+="**");if(mGuild.history)for(video of(counter=0,mGuild.history))counter+=1,history+=`${0-(mGuild.history.length-counter+1)}. [${video.video.title}](https://youtube.com/watch?v=${video.video.id}) - Requested by: ${video.requestor.user.username}#${video.requestor.user.discriminator} - ${video.video.durationFormatted}\n`;return embed=(new discord.MessageEmbed).setTitle("Music queue for this server").addField("History",history).addField("Queue",queue).setColor("#FF8700"),await e.reply({embeds:[embed]})}async function command_volume(e){return e.member.voice.channelId?guilds[e.guild.id]&&guilds[e.guild.id].queue?(musicPermissions=await getMusicPermissions(e.guild.id),musicPermissions.commands&&musicPermissions.commands.volume||e.memberPermissions.has(musicPermissions.permissions)?(mGuild=guilds[e.guild.id],mGuild.resource.volume.setVolume(e.options.getInteger("volume")/100),e.reply({embeds:[functions.getSuccessEmbed("Successfully set volume",`Successfully set volume of [${mGuild.queue[0].video.title}](https://youtube.com/watch?v=${mGuild.queue[0].video.id}) to **${e.options.getInteger("volume")}%**`)]})):e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})):e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]}):e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]})}async function command_pause(e){if(mGuild=guilds[e.guild.id],!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(!mGuild.history)return e.reply({embeds:[functions.getErrorEmbed(errors.NoBack)]});if(musicPermissions.commands&&musicPermissions.commands.pause&&"permissions"!=musicPermissions.commands.pause){if("voting"==musicPermissions.commands.pause&&(vote=await doVotes("pause",e.member,musicPermissions,e.memberPermissions,e.guild.id),!vote.do))return vote.voted?await e.reply({embeds:[functions.getEmbed(`Voted to pause song (${vote.votes}/${vote.required})`,"Get more votes and the song will be paused (others have to do `/pause`)")]}):await e.reply({embeds:[functions.getErrorEmbed(`You have already voted to pause! (${vote.votes}/${vote.required})`)]})}else if(!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]});return await mGuild.player.pause(),mGuild.startedTime=(new Date-mGuild.startedAt)/1e3+mGuild.startedTime,e.reply({embeds:[functions.getSuccessEmbed("Successfully paused",`Successfully paused [${mGuild.queue[0].video.title}](https://youtube.com/watch?v=${mGuild.queue[0].video.id})`)]})}async function command_resume(e){if(mGuild=guilds[e.guild.id],!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(!mGuild.history)return e.reply({embeds:[functions.getErrorEmbed(errors.NoBack)]});if(musicPermissions.commands&&musicPermissions.commands.resume&&"permissions"!=musicPermissions.commands.resume){if("voting"==musicPermissions.commands.resume&&(vote=await doVotes("resume",e.member,musicPermissions,e.memberPermissions,e.guild.id),!vote.do))return vote.voted?await e.reply({embeds:[functions.getEmbed(`Voted to resume song (${vote.votes}/${vote.required})`,"Get more votes and the song will be resumed (others have to do `/resume`)")]}):await e.reply({embeds:[functions.getErrorEmbed(`You have already voted to resume! (${vote.votes}/${vote.required})`)]})}else if(!e.memberPermissions.has(musicPermissions.permissions))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]});return await mGuild.player.unpause(),mGuild.startedAt=new Date,nowPlaying=await getNowPlaying(e.guild.id),await e.reply({embeds:[nowPlaying.setColor("#00FF00")]})}async function command_seek(e){return mGuild=guilds[e.guild.id],e.member.voice.channelId?guilds[e.guild.id]&&guilds[e.guild.id].queue?(musicPermissions=await getMusicPermissions(e.guild.id),musicPermissions.commands&&musicPermissions.commands.seek||e.memberPermissions.has(musicPermissions.permissions)?(await e.deferReply(),guilds[e.guild.id].queue[0].seek=e.options.getInteger("seek"),await guilds[e.guild.id].playLoop(),nowPlaying=await getNowPlaying(e.guild.id),await e.followUp({embeds:[nowPlaying.setColor("#00FF00")]})):e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]})):e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]}):e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]})}async function getNowPlaying(e,i=0){if(mGuild=guilds[e],0==i&&(i=mGuild.index),embed=(new discord.MessageEmbed).setColor("#FF8700").setTitle("Now playing:").addField("Requestor",mGuild.queue[i].requestor.user.username+"#"+mGuild.queue[i].requestor.user.discriminator,inline=!0),i>0&&embed.setTitle("Added to queue:"),mGuild.queue[i].video.thumbnail)if(embed.setThumbnail(mGuild.queue[i].video.thumbnail.url),embed.setDescription(`[${mGuild.queue[i].video.title}](https://youtube.com/watch?v=${mGuild.queue[i].video.id})`),0==i){multiplier=1,mGuild.filters.speed&&(multiplier=mGuild.filters.speed/100),timeSince=((new Date-mGuild.startedAt)/1e3+mGuild.startedTime)*multiplier;var s=Math.floor(Math.round(timeSince)/60),o=Math.round(timeSince-60*s);embed.addField("Time",`${s}:${o.toString().padStart(2,"0")} / ${mGuild.queue[i].video.durationFormatted}`,inline=!0),timeBar="",timeBarWidth=20,chunks=mGuild.queue[i].video.duration/timeBarWidth;for(var r=0;r<timeBarWidth;r++)(r+1)*chunks<=1e3*timeSince?timeBar+="▓":timeBar+="░";embed.addField("Progress",timeBar)}else embed.addField("Time",mGuild.queue[i].video.durationFormatted,inline=!0);else embed.setDescription(`Couldn't get detailed song information.\nhttps://youtube.com/watch?v=${mGuild.queue[i].video.id}`);return embed}async function command_filter(e){if(!e.member.voice.channelId)return e.reply({embeds:[functions.getErrorEmbed(errors.NotInVoiceChannel)]});if(!guilds[e.guild.id]||!guilds[e.guild.id].queue)return e.reply({embeds:[functions.getErrorEmbed(errors.NotPlaying)]});if(musicPermissions=await getMusicPermissions(e.guild.id),!(musicPermissions.commands&&musicPermissions.commands.loop||e.memberPermissions.has(musicPermissions.permissions)))return e.reply({embeds:[functions.getErrorEmbed(errors.missingPermissions(musicPermissions.permissions))]});if(null!=e.options.getInteger("bass"))if(100!=e.options.getInteger("bass")){if(guilds[e.guild.id].filters.pitch&&0!=e.options.getInteger("pitch"))return await e.reply({embeds:[functions.getErrorEmbed(`You can't use bass and pitch filter at the same time! Use \`/filter bass:${e.options.getInteger("bass")} pitch:0\` to remove pitch filter and set bass.`)]});if(guilds[e.guild.id].filters.speed&&100!=e.options.getInteger("speed"))return await e.reply({embeds:[functions.getErrorEmbed(`You can't use bass and speed filter at the same time! Use \`/filter bass:${e.options.getInteger("bass")} speed:100\` to remove pitch filter and set speed.`)]});guilds[e.guild.id].filters.bass,guilds[e.guild.id].filters.bass=e.options.getInteger("bass")}else guilds[e.guild.id].filters.bass&&delete guilds[e.guild.id].filters.bass;if(null!=e.options.getInteger("pitch"))if(0!=e.options.getInteger("pitch")){if(guilds[e.guild.id].filters.bass&&100!=e.options.getInteger("bass"))return await e.reply({embeds:[functions.getErrorEmbed(`You can't use bass and pitch filter at the same time! Use \`/filter bass:100 pitch:${e.options.getInteger("pitch")}\` to remove bass filter and set pitch.`)]});guilds[e.guild.id].filters.pitch,guilds[e.guild.id].filters.pitch=e.options.getInteger("pitch")}else guilds[e.guild.id].filters.pitch&&delete guilds[e.guild.id].filters.pitch;if(null!=e.options.getInteger("speed"))if(100!=e.options.getInteger("speed")){if(guilds[e.guild.id].filters.bass&&100!=e.options.getInteger("bass"))return await e.reply({embeds:[functions.getErrorEmbed(`You can't use bass and speed filter at the same time! Use \`/filter bass:100 speed:${e.options.getInteger("speed")}\` to remove bass filter and set speed.`)]});guilds[e.guild.id].filters.speed,guilds[e.guild.id].filters.speed=e.options.getInteger("speed")}else guilds[e.guild.id].filters.speed&&delete guilds[e.guild.id].filters.speed;multiplier=1,guilds[e.guild.id].filters.speed&&(multiplier=guilds[e.guild.id].filters.speed/100),timeSince=((new Date-mGuild.startedAt)/1e3+mGuild.startedTime)*multiplier,guilds[e.guild.id].queue[0].seek=timeSince,await guilds[e.guild.id].playLoop(),guilds[e.guild.id].queue[0].seek=0}permissionsAll="MOVE_MEMBERS",errors=new functions.Errors,guilds={},bot.on("ready",async function(){console.log(bot.user.tag+" online")}),songCache={},bot.on("interactionCreate",async e=>{e.isAutocomplete()&&("play"==e.commandName&&await autocomplete_play(e),"skipto"==e.commandName&&await autocomplete_queueItem(e,"track"),"remove"==e.commandName&&await autocomplete_queueItem(e,"track",ignoreFirst=!0)),e.isCommand()&&("play"==e.commandName&&await command_play(e),"stop"==e.commandName&&await command_stop(e),"skip"==e.commandName&&await command_skip(e),"now-playing"==e.commandName&&await command_nowplaying(e),"queue"==e.commandName&&await command_queue(e),"back"==e.commandName&&await command_back(e),"volume"==e.commandName&&await command_volume(e),"pause"==e.commandName&&await command_pause(e),"resume"==e.commandName&&await command_resume(e),"seek"==e.commandName&&await command_seek(e),"lyrics"==e.commandName&&await command_lyrics(e),"skipto"==e.commandName&&await command_skipto(e),"remove"==e.commandName&&await command_remove(e),"restart"==e.commandName&&await command_restart(e),"loop"==e.commandName&&await command_loop(e),"filter"==e.commandName&&await command_filter(e))}),bot.login(process.env.token);